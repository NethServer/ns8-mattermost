#!/bin/bash

#
# Copyright (C) 2023 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#
set -e

if [ -z ${CALLS_TCP_PORT} ] || [ -z ${CALLS_UDP_PORT} ]; then
    printf "Port numbers for Calls plugin are not set. Calls might not work!\n" 1>&2
    exit 0
fi

# Set on the fly the calls settings
printf '{
    "PluginSettings": {
        "Plugins": {
            "com.mattermost.calls": {
                "icehostoverride": "%s",
                "tcpserverport": %d,
                "udpserverport": %d,
                "defaultenabled": true
            }
        }
    }
}\n' "${TRAEFIK_HOST}" ${CALLS_TCP_PORT} ${CALLS_UDP_PORT} | podman exec -i mattermost-app mmctl --local config patch /dev/stdin
podman exec -i mattermost-app mmctl --local config reload
